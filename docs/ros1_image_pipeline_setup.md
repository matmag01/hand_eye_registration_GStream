# Setting ROS1 Image pipeline 

The following document describes how to set up some required features from the [ROS1 image pipeline][1] needed to use the hand-eye calibration script. Three steps need to be performed: (1) calibrating cameras, (2) publishing calibration parameters in `camera_info` topic, and (3) undistort and republish frames.

[1]: https://wiki.ros.org/image_pipeline

## Step 1: print calibration checkerboard

Print checkerboard from here: <https://github.com/Cartucho/dvrk_calib_hand_eye/blob/main/camera_calibration.md>.  This pattern has the following features:
* Square size: 4.80mm -> 0.00480m
* Size: 22x17

Check the printer has not scaled the checkerboard by measuring the square size. Other patterns can be used but the `square_size` and the `size` are needed when calling the calibration scripts.

## Step 2: Create package to store camera calibrations

Before launching your video pipeline, you should create a package to store the camera calibration parameters. Make sure that the name of your package is the same as the `rig_name` defined in your launch file. You can create a package with the following commands:

```bash
cd ~/catkin_ws/src
catkin_create_pkg <rig_name>
cd ~/catkin_ws
catkin build
source ~/catkin_ws/devel/setup.bash
```

Then launch the file with

```bash
roslaunch dvrk_camera_registration jhu_daVinci_video.launch
```

Make sure that you are not getting warnings such as

```
[ WARN] [1713557429.852579673]: unknown package: jhu_daVinci_endoscope_calibration (ignored)
```

This implies that the package was not found in the workspace. Try to rebuild the workspace with `catkin build`, source the workspace again, and the relaunch the video launch file.

## Step 2: Camera calibration 

```
rosrun camera_calibration cameracalibrator.py --approximate 0.1 --size 12x10 --square 0.0045 right:=/jhu_daVinci/right/image_raw left:=/jhu_daVinci/left/image_raw right_camera:=/jhu_daVinci/right left_camera:=/jhu_daVinci/left
```

After calibration, click on the commit button to save your calibrations in the package that was created in the previous step.

### Deprecated (See what should be kept in the final version of the documentation)
Camera calibration can be performed with any software that generates the standard 3x3 camera intrinsics and 1x5 distortion coefficients specified in OpenCV. Since the hand-eye calibration expects the parameters to be published in a standard ROS topic, it is recommended to use ROS utils to calibrate the cameras.

Monocular calibration (Single camera)
```bash
rosrun camera_calibration cameracalibrator.py --size 22x17 --square 0.0048 image:=/jhu_daVinci/left/decklink/jhu_daVinci_left/image_raw camera:=/jhu_daVinci/left/decklink/jhu_daVinci_left/ --no-service-check
```

Stereo calibration (Camera pair)
```bash
rosrun camera_calibration cameracalibrator.py --approximate 0.1 --size 22x17 --square 0.0048 right:=/jhu_daVinci/decklink/right/image_raw left:=/jhu_daVinci/decklink/left/image_raw right_camera:=/my_stereo/right left_camera:=/my_stereo/left --no-service-check
```

After running the calibration GUI make sure to save the calibration parameters. The application will create a compressed file with the pictures used for calibration and a `yaml` file with the actual parameters. 

### Checking the calibration's quality
After generating the camera parameters, hold the calibration board in front of the camera again to see the epipolar error. According to [ROS documentation][epipolar_error] this error should be ideally below 0.1 pixels. The best error I was able to obtained with an old dVRK endoscope was around 1.3 pixels. Handeye calibration is very sensitive to bad calibrations.

[epipolar_error]: <https://wiki.ros.org/camera_calibration/Tutorials/StereoCalibration#:~:text=Typically%2C%20an%20epipolar%20error%20below,acceptable%2C%20and%20below%200.1%20excellent>

<details>
  <summary>ROS camera calibration utils documentation</summary>
  
* [Camera calibration in ros](https://wiki.ros.org/camera_calibration)
* [Monocular calibration](https://wiki.ros.org/camera_calibration/Tutorials/MonocularCalibration)
* [Stereo calibration](https://wiki.ros.org/camera_calibration/Tutorials/StereoCalibration)
</details>


## Step 3 - Modify video launch files 

Modify the video launch file so that correct camera parameters are published in `camera_info` topic. To do this extract the .yaml file generated by the calibration script and add the location of this file to the video [pipeline launch file](../video_launch_files/jhu_daVinci_video.launch).

```xml
<arg name="camera_info_file" value="file:////home/jbarrag3/research_juan/hand_eye_collect/data_ros_calib/stereo_calib1/right.yaml"/>
```

Modify this file for both left and right cameras.

<details>
  <summary> Image info publisher documentation</summary>

* [Image publisher](https://wiki.ros.org/image_publisher?distro=noetic)
* [Camera info](https://wiki.ros.org/image_pipeline/CameraInfo)
* [Publishing parameters with a script](https://gist.github.com/rossbar/ebb282c3b73c41c1404123de6cea4771)
</details>

## Step 4: Rectify (undistorted) images 

Images can be rectified, i.e., undistorted with the `stereo_image_proc` function in the `image_pipeline`

```bash
ROS_NAMESPACE=/jhu_daVinci/decklink/ rosrun stereo_image_proc stereo_image_proc
```

After running this script you should obtain an `image_rect_color` topic for your left and right cameras.

```
rosrun image_view image_view image:=/jhu_daVinci/decklink/left/image_rect_color
```

<details>
  <summary>Image processing documentation</summary>

* [Monocular image proc](https://wiki.ros.org/image_proc)
* [Stereo image proc](https://wiki.ros.org/stereo_image_proc)

</details>


<details>
  <summary> Trouble shooting the image processor </summary>

The ROS image processing package expects the topics in a very specific format to process the pair of stereo images. If you are using a different launch file than the one provided in this repo check that the topics have the right format

```bash
rostopic list | grep image_raw$
```

This command should result in 
```bash
/jhu_daVinci/decklink/left/image_raw
/jhu_daVinci/decklink/right/image_raw
```
</details>



## Additional resources

* <https://jeffzzq.medium.com/ros2-image-pipeline-tutorial-3b18903e7329>
* <https://crtk-robotics.readthedocs.io/en/latest/pages/clients.html#>


